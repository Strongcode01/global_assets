{% extends "dashboard/base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/cards/css/card.css' %}">
{% endblock %}
{% block title %}Pre-order Card{% endblock %}

{% block content %}
<div class="card-preorder-page">

  <div class="card-preview preorder">
      <div class="card-chip"></div>
      <div class="card-logo">Ofsgesara.io</div>
      <div class="card-number" id="previewNumber">0000 0000 0000 0000</div>
      <div class="card-bottom">
          <div class="card-name" id="previewName">{{ request.user.get_full_name|default:request.user.username }}</div>
          <div class="card-expiry" id="previewExpiry">VALID THRU 11/24</div>
      </div>
      <div class="card-status">Status: <strong>Pre-order</strong></div>
  </div>

  <div class="preorder-form">
      <h2>Pre-order Your Card</h2>
      <p class="muted">Your full name (as it will appear on the card). Admin will approve requests; if approved your card is issued and activated.</p>

      <form method="POST" novalidate>
          {% csrf_token %}
          {{ form.non_field_errors }}
          <div class="form-row">
              {{ form.name_on_card.label_tag }}
              {{ form.name_on_card }}
              {{ form.name_on_card.errors }}
          </div>
          <div class="form-row">
              <label for="id_pin">Transaction PIN (4 digits)</label>
              <input id="id_pin" name="pin" type="password" maxlength="4" pattern="\d{4}" placeholder="1234" required class="input-pin">
          </div>
          <button type="submit" class="btn-primary">Pre-order Card</button>
      </form>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const nameInput = document.querySelector('[name="name_on_card"]');
    const previewName = document.getElementById("previewName");
    const previewNumber = document.getElementById("previewNumber");
    const previewExpiry = document.getElementById("previewExpiry");

    function randomPreviewNumber() {
      return Array.from({length:4}, () => Math.floor(1000 + Math.random()*9000)).join(" ");
    }

    previewNumber.textContent = randomPreviewNumber();

    if (nameInput) {
        nameInput.addEventListener("input", (e) => {
            previewName.textContent = (e.target.value || "{{ request.user.get_full_name|default:request.user.username }}").toUpperCase();
        });
    }

    const now = new Date();
    const expiryYear = now.getFullYear() + 3;
    const expiryMonth = String(now.getMonth() + 1).padStart(2,"0");
    previewExpiry.textContent = `VALID THRU ${expiryMonth}/${String(expiryYear).slice(-2)}`;

    setInterval(()=>{ previewNumber.textContent = randomPreviewNumber(); }, 8000);
});
</script>
{% endblock %}