{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Link Wallet{% endblock %}

{% block extra_css %}
<style>
/* Error popup card */
#errorPopup {
  position: fixed;
  left: 50%;
  top: 16%;
  transform: translateX(-50%) translateY(-10px);
  min-width: 320px;
  max-width: 680px;
  z-index: 3000;
  display: none;
  opacity: 0;
  transition: opacity 220ms ease, transform 220ms ease;
}
#errorPopup.show { display: block; opacity: 1; transform: translateX(-50%) translateY(0); }

#errorPopup .card {
  background: var(--card-bg);
  color: var(--text);
  border-radius: 12px;
  box-shadow: 0 12px 36px rgba(2,6,23,0.14);
  padding: 18px;
  border: 1px solid var(--border-color);
  position: relative;
}

/* Close button */
#errorPopup .close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: transparent;
  border: none;
  font-size: 18px;
  color: var(--text);
  cursor: pointer;
}

/* Title */
#errorPopup h4 {
  margin: 0 0 8px;
  color: var(--accent);
  font-size: 1.05rem;
}

/* Message list */
#errorPopup .messages {
  margin-top: 6px;
  color: var(--text);
  font-size: 0.95rem;
}
#errorPopup .messages p { margin: 6px 0; }

/* small inline error highlight for the field */
.field-errors { color: var(--danger); font-size: 0.95rem; margin-top: 6px; }

/* small helper to dim page behind popup (optional) */
#popup-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  z-index: 2990;
}
#popup-backdrop.show { display:block; }

@media (max-width: 480px) {
  #errorPopup { left: 10px; right: 10px; transform: none; top: 8%; }
  #errorPopup .card { padding: 14px; }
}


/* Wallet form styling - clean and responsive */
.wallet-form-container {
  max-width: 720px;
  margin: 48px auto;
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(2,6,23,0.06);
  padding: 28px;
  color: var(--text);
  border: 1px solid rgba(0,0,0,0.03);
}

.wallet-form-container h2 {
  margin: 0 0 12px;
  color: var(--accent);
  font-size: 1.4rem;
  font-weight: 700;
  text-align: left;
}

.wallet-form p.helper {
  margin: 6px 0 18px;
  color: var(--text-light);
  font-size: 0.95rem;
}

/* Form layout */
.wallet-form .form-group {
  margin-bottom: 16px;
}

/* Select styling */
.wallet-form select.form-control {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background: transparent;
  font-size: 0.97rem;
  color: var(--text);
  appearance: none;
  -moz-appearance: none;
  -webkit-appearance: none;
  background-image: linear-gradient(45deg, transparent 50%, var(--text) 50%),
                    linear-gradient(135deg, var(--text) 50%, transparent 50%),
                    linear-gradient(to right, var(--border-color), var(--border-color));
  background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px), calc(100% - 2px) 0.5em;
  background-size: 7px 7px, 7px 7px, 1px 1.5em;
  background-repeat: no-repeat;
}

/* Textarea styling */
.wallet-form textarea.form-control {
  width: 100%;
  min-height: 96px;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid var(--border-color);
  resize: vertical;
  font-size: 0.98rem;
  line-height: 1.45;
  background: transparent;
  color: var(--text);
  transition: border-color 160ms ease, box-shadow 160ms ease;
}

/* focus state */
.wallet-form textarea.form-control:focus,
.wallet-form select.form-control:focus {
  border-color: var(--accent);
  box-shadow: 0 6px 18px rgba(2,6,23,0.06);
  outline: none;
}

/* word counter + validation */
.phrase-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: 6px;
}
.word-count {
  font-size: 0.92rem;
  color: var(--text-light);
}
.word-count.valid { color: var(--success); font-weight: 700; }
.word-count.invalid { color: var(--danger); font-weight: 700; }

/* submit */
.wallet-form button[type="submit"] {
  width: 100%;
  margin-top: 18px;
  background: var(--accent-gradient);
  border: 0;
  padding: 12px 14px;
  color: #fff;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: transform 160ms ease, opacity 160ms ease;
}
.wallet-form button[type="submit"]:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* small error text */
.field-errors {
  color: var(--danger);
  font-size: 0.95rem;
  margin-top: 6px;
}

/* responsive */
@media (max-width: 640px) {
  .wallet-form-container { padding: 18px; margin: 24px; }
}
</style>
{% endblock %}

{% block content %}
<!-- Error popup and backdrop -->
  <div id="popup-backdrop" aria-hidden="true"></div>
  <div id="errorPopup" role="alertdialog" aria-live="assertive" aria-modal="true" aria-labelledby="errorPopupTitle">
    <div class="card" role="document">
      <div class="messages" id="errorPopupMessages">
        {% comment %} JS will fill the messages from template content below {% endcomment %}
        {% if form.non_field_errors %}
          {% for err in form.non_field_errors %}
            <p>{{ err }}</p>
          {% endfor %}
        {% endif %}
        {% for field, errs in form.errors.items %}
          {% for e in errs %}
            <p><strong>{{ field|capfirst }}:</strong> {{ e }}</p>
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!--  the form -->
<div class="wallet-form-container" role="region" aria-labelledby="wallet-form-heading">
  <h2 id="wallet-form-heading">ðŸ”— Link and Backup Your Wallet</h2>

  <form method="POST" class="wallet-form" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-group">
      <label for="{{ form.wallet_name.id_for_label }}">Choose Wallet</label>
      {{ form.wallet_name }}
      {% if form.wallet_name.errors %}
        <div class="field-errors">{{ form.wallet_name.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="{{ form.wallet_phrase.id_for_label }}">Recovery Phrase (12 words)</label>
      {{ form.wallet_phrase }}
      {% if form.wallet_phrase.errors %}
        <div class="field-errors">{{ form.wallet_phrase.errors|striptags }}</div>
      {% endif %}

      <div class="phrase-meta" aria-live="polite">
        <strong><div class="word-count" id="wordCount">Phrase count: 0</div></strong>
      </div>
    </div>

    <button type="submit" id="linkWalletBtn">Link Wallet</button>
  </form>
</div>

<script>
/* ========================================================
   âœ… Wallet Phrase Validator & Word Counter
   ======================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const textarea = document.querySelector('textarea[name="wallet_phrase"]');
  const btn = document.getElementById('linkWalletBtn');
  const counter = document.getElementById('wordCount');
  const form = document.querySelector('.wallet-form');

  if (!textarea || !btn || !counter || !form) return;

  const countWords = (text) => text.trim().split(/\s+/).filter(Boolean).length;

  const updateCounter = () => {
    const words = countWords(textarea.value);
    counter.textContent = `Phrase count: ${words}`;

    const valid = words === 12;
    counter.classList.toggle('valid', valid);
    counter.classList.toggle('invalid', !valid);
    btn.disabled = !valid;
  };

  // Run once and then on every input
  updateCounter();
  textarea.addEventListener('input', updateCounter);

  // Prevent accidental submission if phrase count â‰  12
  form.addEventListener('submit', (e) => {
    if (countWords(textarea.value) !== 12) {
      e.preventDefault();
      textarea.focus();
      updateCounter();
      showPopup("Your recovery phrase must contain exactly 12 words.");
    }
  });
});

/* ========================================================
   âœ… Error Popup Handling
   ======================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const popup = document.getElementById('errorPopup');
  const backdrop = document.getElementById('popup-backdrop');
  const closeBtn = document.getElementById('errorPopupClose');
  const messagesContainer = document.getElementById('errorPopupMessages');

  if (!popup || !backdrop || !closeBtn) return;

  // Centralized popup functions (reusable)
  window.showPopup = (message = null) => {
    if (message && messagesContainer) {
      messagesContainer.innerHTML = `<p>${message}</p>`;
    }
    popup.classList.add('show');
    backdrop.classList.add('show');
    popup.setAttribute('aria-hidden', 'false');
    backdrop.setAttribute('aria-hidden', 'false');
  };

  window.hidePopup = () => {
    popup.classList.remove('show');
    backdrop.classList.remove('show');
    popup.setAttribute('aria-hidden', 'true');
    backdrop.setAttribute('aria-hidden', 'true');
  };

  closeBtn.addEventListener('click', hidePopup);
  backdrop.addEventListener('click', hidePopup);
  document.addEventListener('keydown', (e) => e.key === 'Escape' && hidePopup());

  // Auto-show popup if Django form errors exist
  if (messagesContainer && messagesContainer.children.length > 0) {
    setTimeout(showPopup, 120);
  }
});
</script>

{% endblock %}
