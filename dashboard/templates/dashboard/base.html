{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Dashboard{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'dashboard/css/style.css' %}">
  {% block extra_css %}{% endblock %}  
  <style>
    /* ===============================================
       GLOBAL LOADER
    ================================================ */
    #global-page-loader {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
      background: rgba(2, 0, 3, 0.9);
    }
    #global-page-loader.show { display: flex; }

    .loader5 {
      position: relative;
      width: 80px;
      height: 80px;
    }
    .loader5 span {
      position: absolute;
      border: 3px solid #aa90d3;
      border-radius: 50%;
      opacity: 1;
      animation: loader5-animation 1.2s cubic-bezier(0, 0.2, 0.8, 1) infinite;
    }
    .loader5 span:nth-child(2) { animation-delay: -0.5s; }

    @keyframes loader5-animation {
      0%, 4.9% { top: 36px; left: 36px; width: 0; height: 0; opacity: 0; }
      5% { opacity: 1; }
      100% { top: 0; left: 0; width: 72px; height: 72px; opacity: 0; }
    }
    /* ============================================== 
        LOGO
     ===============================================*/
    .brand {
        display: flex;
        align-items: center;
        justify-content: flex-start; /* or center depending on your layout */
    }

    .brand-logo {
        height: 100px;       /* adjust as needed */
        width: auto;        /* keeps ratio */
        object-fit: contain;
        border-radius: 6px; /* optional */
    }
    @media (max-width: 600px) {
        .brand-logo {
            height: 36px;   /* smaller on mobile */
        }
    }
    /* ===============================================
       SIDEBAR & NAVIGATION
    ================================================ */
    .sidebar {
      background: var(--card-bg);
      padding: 20px;
      width: 250px;
      height: 100vh;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      transition: transform 0.3s ease-in-out;
      z-index: 999;
    }

    .sidebar nav a {
      display: block;
      color: var(--text);
      padding: 10px 0;
      text-decoration: none;
      transition: color 0.3s;
    }

    .sidebar nav a:hover {
      color: var(--accent);
    }

    .brand {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 30px;
    }

    #theme-toggle {
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      margin-top: 1rem;
    }

    /* ===============================================
       LAYOUT
    ================================================ */
    .layout {
      display: flex;
    }

    .content {
      margin-left: 260px;
      padding: 20px;
      width: calc(100% - 260px);
      transition: margin-left 0.3s ease;
    }

    /* ===============================================
       PROFILE SECTION
    ================================================ */
    .profile-info {
      text-align: right;
      padding: 1rem;
    }

    .profile-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ddd;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .welcome-title {
      margin-top: 10px;
      color: var(--text);
    }

    /* ===============================================
       CRYPTO WIDGETS
    ================================================ */
    .crypto-widgets {
      margin: 30px 0;
    }

    .crypto-widgets iframe {
      width: 100%;
      min-height: 60px;
      display: block;
      border: none;
      border-radius: 10px;
    }

    .market-ticker,
    .market-chart {
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 15px;
      margin-bottom: 40px;
    }

    .market-ticker iframe { height: 30px; }
    .market-chart iframe { height: 400px; }

    /* ===============================================
       MOBILE RESPONSIVE
    ================================================ */
    .hamburger {
      display: none;
      cursor: pointer;
      font-size: 1.8rem;
      background: none;
      border: none;
      color: var(--text);
      position: fixed;
      top: 15px;
      left: 20px;
      z-index: 1001;
    }

    @media (max-width: 768px) {
      .hamburger { display: block; }

      .sidebar {
        transform: translateX(-100%);
        width: 230px;
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .content {
        margin-left: 0;
        width: 100%;
      }
    }

    footer {
      text-align: center;
      padding: 15px;
      color: #999;
      font-size: 0.9rem;
    }
    .notif-popup {
      position: fixed;
      right: 20px;
      top: 20px;
      background: #6d76e7;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(15px);
      transition: all 0.4s ease;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .notif-popup.show {
      opacity: 1;
      transform: translateY(0);
    }

  </style>
</head>
<body>
  <!-- Spinner overlay -->
  <div id="global-page-loader" aria-hidden="true">
    <div class="loader5" role="status" aria-label="Loading">
      <span></span><span></span>
    </div>
  </div>

  <!-- ====================================================== 
  The popup notification
  ========================================================= -->
  <div id="popup-container"></div>


  <div class="layout">
    <button class="hamburger" id="hamburger" aria-label="Menu">‚ò∞</button>
    <aside class="sidebar">
      <div class="brand">
        <img src="{% static 'core/images/logo.png' %}" alt="QFS Global Logo" class="brand-logo">
    </div>
      <nav>
        <a href="{% url 'dashboard:dashboard' %}">Dashboard</a>
        <a href="{% url 'dashboard:link_wallet' %}">Link Wallet</a>
        <a href="{% url 'dashboard:transactions' %}">Transactions</a>
        <a href="{% url 'dashboard:kyc' %}">KYC Status</a>
        <a href="{% url 'dashboard:my_card' %}">QFS Credit Card</a>
        <a href="{% url 'core:home' %}">Home</a>
        <a href="https://t.me/{{tg_username}}" target="_blank" rel="noopener noreferrer">Supports</a></span>
        <a href="{% url 'core:logout' %}">Logout</a>
      </nav>
      <script src="https://files.coinmarketcap.com/static/widget/currency.js"></script>
      <div class="coinmarketcap-currency-widget" style="display: flex; max-width: fit-content; border: none;" 
          data-currencyid="52"            
          data-base="USD"
          data-ticker="true"
          data-rank="false"
          data-marketcap="false"
          data-volume="false"
          data-statsticker="false">
      </div>

      <button id="theme-toggle">üåì Toggle Theme</button>
    </aside>

    <main class="content">
      <div class="profile-info" role="region" aria-label="User profile summary">
        {% if profile_pic_url %}
          <img src="{{ profile_pic_url }}" alt="{{ request.user.username }}'s profile picture"
               class="profile-avatar" loading="lazy">
        {% else %}
          <img src="{% static 'dashboard/images/default-avatar.png' %}" 
               alt="Default avatar" class="profile-avatar" loading="lazy">
        {% endif %}
        <h4 class="welcome-title">
          Hi, {{ request.user.username|default:"User" }}
        </h4>
      </div>

      <!-- LIVE CRYPTO WIDGETS -->
      <div class="coingecko-widget-ticker">
      <script src="https://widgets.coingecko.com/coingecko-coin-ticker-widget.js"></script>
      <coingecko-coin-ticker-widget 
        coin-ids="ripple" 
        currency="usd" 
        locale="en" 
        width="100%" 
        height="60">
      </coingecko-coin-ticker-widget>
    </div>



        {% block content %}{% endblock %}

        <!-- TradingView Embed for XRPUSD -->
        <div class="tradingview-widget-container">
          <div id="tv_chart_container"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
          <script type="text/javascript">
            new TradingView.widget({
              "width": "100%",
              "height": 400,
              "symbol": "COINBASE:XRPUSD",
              "interval": "60",
              "timezone": "Etc/UTC",
              "theme": "light",
              "style": "1",
              "toolbar_bg": "#f1f3f6",
              "withdateranges": true,
              "hidecommunity": true,
              "allow_symbol_change": true,
              "container_id": "tv_chart_container"
            });
          </script>
        </div>

      </div>
    </main>
  </div>

  <footer>
    &copy; 2025 QFS Global Asset - All rights reserved.
  </footer>

  <script>
    // Apply saved theme on load
    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("theme") || "light";
      document.documentElement.dataset.theme = savedTheme;
    });

    // Theme toggle logic
    const toggle = document.getElementById('theme-toggle');
    toggle.addEventListener('click', () => {
      const current = document.documentElement.dataset.theme;
      const next = current === 'light' ? 'dark' : 'light';
      document.documentElement.dataset.theme = next;
      localStorage.setItem("theme", next);
      updateWidgetTheme();
    });

    document.addEventListener("DOMContentLoaded", () => {
      try {
        const frame = document.getElementById("coinlib-frame");
        frame.addEventListener("error", () => {
          console.warn("Coinlib widget failed to load. Showing fallback message.");
          document.getElementById("coinlib-container").innerHTML =
            "<div style='text-align:center; padding:1rem; color:#999;'>‚ö†Ô∏è Coin data unavailable. Please try again later.</div>";
        });
      } catch (err) {
        console.error("Coinlib widget error:", err);
        document.getElementById("coinlib-container").innerHTML =
          "<div style='text-align:center; padding:1rem; color:#999;'>‚ö†Ô∏è Unable to display widget.</div>";
      }
    });
    // Sidebar toggle
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.querySelector('.sidebar');
    hamburger.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      hamburger.textContent = sidebar.classList.contains('active') ? '‚úñ' : '‚ò∞';
    });

    // Loader behavior
    (function () {
      const loader = document.getElementById('global-page-loader');
      const show = () => loader.classList.add('show');
      const hide = () => loader.classList.remove('show');
      document.addEventListener('click', e => {
        const a = e.target.closest('a');
        if (a && a.href && a.target !== '_blank' && !a.href.startsWith('#')) show();
      }, true);
      document.addEventListener('submit', () => show(), true);
      window.addEventListener('pageshow', hide);
      window.addEventListener('beforeunload', show);
    })();

    function fetchNotifications() {
      fetch("/notifications/latest/")
        .then(response => response.json())
        .then(data => {
          data.notifications.forEach((n, index) => {
            showPopup(`User: ${n.user_name}\n\n${n.title} - ${n.status}\n${n.created_at}`);
          });
        });
    }

    function showPopup(message) {
      const popup = document.createElement("div");
      popup.className = "notif-popup";
      popup.innerText = message;
      document.body.appendChild(popup);

      setTimeout(() => popup.classList.add("show"), 100);
      setTimeout(() => {
        popup.classList.remove("show");
        setTimeout(() => popup.remove(), 500);
      }, 6000);
    }

    // Fetch every 10 seconds
    setInterval(fetchNotifications, 10000);
  </script>
</body>
</html>
